# IBKR Hotkey Trader - Project Requirements

## Project Overview
Застосунок для швидкого трейдингу через IBKR API з можливістю реактивно купляти і продавати певний тікер по хот кеям.

- **Мова інтерфейсу:** Англійська
- **Технології:** Qt (C++), IBKR TWS API
- **Спосіб підключення:** Trader Workstation (TWS) через localhost socket (користувач встановлює і запускає окремо)


## Main Window Layout

### Top Toolbar (невисока панель)
**Зліва:**
- Назва поточного тікера
- При кліку або `Cmd+K` → попап пошуку символа з автокомплітом
- Результати можна обрати стрілками вверх/вниз та Enter

**В центрі (на вертикальному рівні з чартом):**
Кнопки трейдингу:
- `Open 100%` (трохи ширша)
- `Open 50%`
- `+5%` .. `+50%`
- `---` (розділювач)
- `Cancel` - закриває всі невиконані pending orders
- `---` (розділювач)
- `Close 25%` .. `Close 100%` (остання ширша)

*Всі кнопки роблять те саме що і хоткеї, але для мишки*

**Справа:**
- Кнопка `Settings`

### Menu Bar

**IBKR Hotkey Trader:**
- About
- ---
- Settings
- ---
- Quit

**File:**
- New Symbol
- ---
- Reset Session

**Orders:**
- (Hotkeys згадані вище)

**Help:**
- Help documentation

### Left Panel (вузька)
Список символів (включаючи поточний) які відкривались за сьогодні:
- Під тікером: поточна ціна зі стріму `reqTickByTickData`
- Колір: червона або зелена в залежності від руху ціни
- Поряд: % зміни за останні 10 сек
- Подвійний клік на айтемі → переміщає його на початок списку
- Хрестик праворуч → видалити зі списку

### Center Panel - Chart
10-секундний свічковий чарт поточного тікера:
- На старті: `reqHistoricalData` підтягує бари за премаркет (7:00–9:30), або з 7:00 якщо після
- Після відкриття стріму (`reqTickByTickData`): постійно добудовує/оновлює нові 10с бари в реальному часі
- Горизонтальна лінія поточної ціни (як в TradingView)
- Ask і Bid лінії (менш контрастні)

### Right Panel - Trade History
Історія торгівлі сьогодні включаючи невиконані ордери.

**Верхні 2 таби:**
- `Current` - поточні позиції та pending orders
- `All` - вся історія за день

**Кожен айтем містить:**
- Час `hh:mm:ss`
- Тікер
- Кількість
- Ціну відкриття, сума
- Ціну закриття, сума
- PnL в $ (червоний/зелений)
- PnL в % (червоний/зелений)
- Статус:
  - ❌ Pending (по кліку - відмінити order)
  - ✓ Filled (чорна галочка)
  - Cancelled orders НЕ показуються

**Внизу панель статистики за сьогодні:**
- Total account balance $
- Total PnL $
- Total PnL %
- Winrate %
- Number of trades
- Largest win $
- Largest loss $


## Trading Logic & Hotkeys

### Opening Positions (Buy)
- `Cmd+O` - Зайти на 100% суми бюджету
- `Cmd+P` - Зайти на 50% суми
- `Cmd+1` - Зайти/Докупити 5% shares
- `Cmd+2` - Докупити 10% shares
- `Cmd+3` - Докупити 15% shares
- ...
- `Cmd+9` - Докупити 45% shares
- `Cmd+0` - Докупити 50% shares

### Closing Positions (Sell)
- `Cmd+Z` - Sell all shares (100%)
- `Cmd+X` - Sell 75% shares
- `Cmd+C` - Sell 50% shares
- `Cmd+V` - Sell 25% shares

### Other
- `Esc` - Close all pending orders for this ticker
- `Cmd+K` - Open symbol search


## Trading Rules

### General
- Калькуємо кількість акцій % відносно бюджету в settings (округлити вниз до цілого)
- Будь-яка нова IBKR заявка відбувається по поточній real-time ціні:
  - Купівля: `Ask + X` (X задається в settings, default: 10 центів)
  - Продаж: `Bid - Y` (Y задається в settings, default: 10 центів)
- Відкритих позицій + відкритих заявок на покупку **НЕ може бути більше 100%** від бюджету
  - Інакше → жовтий toast warning

### Opening Rules (`Cmd+O`, `Cmd+P`)
**Спрацює тільки якщо немає відкритих позицій** по цьому тікеру:
- Інакше → жовтий toast warning
- Тобто не можна купити 50% а потім ще 50% з `Cmd+P`

**Має оновити попередньо створену pending заявку покупки якщо:**
- Поточна real-time ціна ask вийшла за межі `Ask+X` (тобто заявка вже не спрацює)
- Якщо ми міняємо 50% на 100% (або навпаки) поки заявка pending
- Інакше нічого не відбувається (наприклад клацали `Cmd+P` багато разів → кінечним результатом будуть 50%)
- Оновлена заявка має одразу помінятись в панелі справа

### Adding to Position (`Cmd+1..0`)
**Спрацює тільки коли вже є відкриті позиції** (відкриті з `Cmd+O`,`Cmd+P`):
- Інакше → жовтий toast warning

**Повторні натиски:**
- Оновлюють попередньо створену pending заявку покупки
- Додають відповідний % до quantity (наприклад було 50%, натиснули `Cmd+2` → стає 60%)
- Доки не досягнемо `position + pending = 100%`
  - Інакше → жовтий toast warning
- Оновлена заявка має одразу помінятись в панелі справа

### Selling (`Cmd+Z`, `Cmd+X`, `Cmd+C`, `Cmd+V`)
**% тут це від поточної відкритої позиції, а не від бюджету**

**Програма слідкує за поточною заявкою на продаж:**
- Якщо real-time ціна bid вийшла за межі `Bid-Y` заявки →
  - Оновить заявку до нового `(real-time-bid) - Y`
  - З кожним оновленням значення Y **збільшується вдвічі** (Y, 2Y, 4Y, 8Y...)

**Повторний натиск (будь-який з `Cmd+Z/X/C/V`):**
- **Перестворить** поточну pending заявку з новою `bid-Y` (Y починає знову з дефолтного значення, а не подвоюється)
- Приклад 1: Було 100 акцій, натиснули `Cmd+C` → заявка на продаж 50 акцій (pending), натиснули `Cmd+Z` → стара заявка скасована, створена нова на 100 акцій
- Приклад 2: Маємо 100 акцій, натиснули `Cmd+C` → заявка на 50 спрацювала (filled), натиснули `Cmd+C` → нова заявка на 25 акцій (50% від залишкових 50)

**Оновлення в панелі:**
- Створена, перестворена, оновлена заявка → одразу оновлюється справа
- Відмінені заявки → зникають з панелі (не показуємо cancelled згідно правил)


## Additional Rules

### Symbol Switching
- Поки не закриті всі позиції по тікеру → не можна переключитись на інший
  - Інакше → warning toast

### Toast Notifications
- Має мати фіксовану висоту
- Не зсувати і не закривати важливий контент
- Не втрачати фокус основного вікна
- Краще справа внизу
- Пропадати через 10 сек або по кліку


## Settings Dialog (Popup)

Налаштування зберігаються локально в SQLite

### Tab: Trading
- **Account** (dropdown з підтяганням через IBKR API)
- **Budget $** (float .00, default 1000.00) - загальний бюджет на день
  - Не має перевищувать баланс акаунту → червоний toast warning
  - Якщо перевищує 95% → жовтий toast warning
  - При запуску: якщо бюджет > баланс → відкрити settings з warning
  - Перевірка спрацьовує: після зміни поля, вибору іншого акаунту, або при запуску

### Tab: Limits
- **Ask** - `+[int]` - скільки центів вище ask ставити ордер на купівлю (default: 10)
- **Bid** - `-[int]` - скільки центів нижче bid ставити ордер на продаж (default: 10)

### Tab: Hotkeys
Задаємо бажану % акцій для хоткеїв:
- `Cmd+O` - default: 100%
- `Cmd+P` - default: 50%
- `Cmd+1` - default: 5%
- `Cmd+2` - default: 10%
- ...
- `Cmd+0` - default: 50%
- `Cmd+Z` - default: 100%
- `Cmd+X` - default: 75%
- `Cmd+C` - default: 50%
- `Cmd+V` - default: 25%

### Tab: Connection
- **Host** (default: 127.0.0.1)
- **Port** (default: 7496)
- **ClientId** (default: 1)


## Application Lifecycle

### Startup
- Все пусте і неактивне:
  - Список тікерів зліва порожній
  - Історія торгівлі справа порожня
  - Поточний тікер пустий
  - Списки неактивні
  - Кнопки трейду неактивні
  - Чарт порожній
- Одразу пробує підключитись до TWS
  - При помилках → тости

### Reset Session
1. Запитує "Are you sure?"
2. Закриває всі відкриті позиції і ордери
3. Зупиняє всі стріми
4. Очищує всі дані (як при перезапуску)

### Quit
1. Запитує "Are you sure?"
2. Закриває всі позиції і ордери (чекає позитивну відповідь)
3. Зупиняє всі стріми
4. Очищує всі дані
5. Закриває програму


## Error Handling

### IBKR API Errors
- Всі помилки (створення, оновлення, видалення ордерів) → червоний toast

### Connection Loss
- Клієнт втратив зв'язок з TWS, або TWS з IBKR сервером →
  - Намагається безперервно перепідключитись кожну 1 сек
  - Червоний toast "Reconnecting..."
  - Всі кнопки і функції блокує доки з'єднання не оновлено

### TWS Problems
- TWS запущено але є проблеми (розлогінено юзера тощо) →
  - Пробуємо перепідключитись з червоним повідомленням помилки TWS


## Help & About

### Help
- Відкриває сторінку з інструкцією (англійською)

### About
- Назва застосунку
- Версія: 0.1
- Автор: Kinect.PRO (Anton Pinchuk)
- Посилання: https://kinect-pro.com/solutions/ibkr-hotkey-trader/
- GitHub link
- Ліцензія: MIT


## Technical Details

### Data Storage
- Settings зберігаються в **SQLite** базі даних
- Шлях: OS-specific app data folder
  - macOS: `~/Library/Application Support/IBKRHotkeyTrader/ibkr_hotkey_trader.db`

### IBKR API Integration
- Підключення: localhost socket (TWS API C++ client)
- Протокол: TWS API via EClientSocket
- Real-time data: `reqTickByTickData` для bid/ask
- Historical data: `reqHistoricalData` для свічок
- Orders: через `placeOrder`, `cancelOrder`

### Dependencies
- Qt 6.2+
- CMake 3.16+
- Protocol Buffers (protobuf compiler)
- TWS API (окремо завантажується в `external/twsapi`)
