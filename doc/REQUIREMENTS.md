# IBKR Hotkey Trader - Project Requirements

## Project Overview
Застосунок для швидкого трейдингу через IBKR API з можливістю реактивно купляти і продавати певний тікер по хот кеям.

- **Мова інтерфейсу:** Англійська
- **Технології:** Qt (C++), IBKR TWS API
- **Спосіб підключення:** Trader Workstation (TWS) через localhost socket (користувач встановлює і запускає окремо)


## Main Window Layout

### Top Toolbar (невисока панель)
**Зліва:**
- Назва поточного тікера
- При кліку або `Cmd+K` → попап пошуку символа з автокомплітом
- Результати можна обрати стрілками вверх/вниз та Enter

**В центрі (на вертикальному рівні з чартом):**
Кнопки трейдингу:
- `Open 100%` (трохи ширша)
- `Open 50%`
- `+5%` .. `+50%`
- `---` (розділювач)
- `Cancel` - закриває всі невиконані pending orders
- `---` (розділювач)
- `Close 25%` .. `Close 100%` (остання ширша)

*Всі кнопки роблять те саме що і хоткеї, але для мишки*

**Справа:**
- Кнопка `Settings`

### Menu Bar

**IBKR Hotkey Trader:**
- About
- ---
- Settings
- ---
- Quit

**File:**
- New Symbol
- ---
- Reset Session

**Orders:**
- (Hotkeys згадані вище)

View
- "Show Cancelled and Zero Positions" - показати/сховати скасовані ордери (Current/All tabs) та нульові позиції (Portfolio tab)

**Help:**
- Help documentation

### Left Panel (вузька)
Список символів (включаючи поточний) які відкривались за сьогодні:
- Під тікером: поточна ціна зі стріму `reqTickByTickData`
- Колір: червона або зелена в залежності від руху ціни
- Поряд: % зміни за останні 10 сек
- Подвійний клік на айтемі → переміщає його на початок списку
- Хрестик праворуч → видалити зі списку

### Center Panel - Chart
10-секундний свічковий чарт поточного тікера:
- На старті: `reqHistoricalData` підтягує бари за премаркет (7:00–9:30), або з 7:00 якщо після
- Після відкриття стріму (`reqTickByTickData`): постійно добудовує/оновлює нові 10с бари в реальному часі
- Горизонтальні лінії поточної ціни, бід і аск (як в TradingView, ціна справа)
- Горизонтальна лінія усрєдньонної позицій (з даних портфоліо)
- Мої входи і виходи (стрілки як в TradingView) (з даних filled ордерів)

### Right Panel - Portfolio & Trade History
Портфоліо та історія торгівлі з динамічним оновленням.

**Верхні 3 таби:**
- `Current` - orders по поточному тікеру
- `All` - вся історія ордерів за день (всі тікери)
- `Portfolio` - поточні позиції портфеля з real-time P&L (з IBKR API)

**Current/All Tabs - таблиця ордерів:**
Колонки:
- **Status** - статус ордера:
  - ⏳ Pending (по кліку - відмінити order)
  - ✅ Filled (чорна галочка)
  - ✖️ Cancelled (сірий, показується тільки якщо checkbox активний)
- **Symbol** - тікер
- **Buy/Sell** - тип операції (колір: зелений для Buy, червоний для Sell)
- **Qty** - кількість акцій
- **Price** - ціна виконання (для Pending - limit price)
- **Cost** - загальна вартість (Qty × Price)
- **Commission** - комісія (для Filled ордерів)
- **Time** - час `hh:mm:ss`

**Portfolio Tab - таблиця позицій:**
Колонки:
- **Symbol** - тікер
- **Position** - кількість акцій
- **Avg Cost** - середня ціна відкриття
- **Market Value** - поточна вартість позиції
- **Unrealized P&L** - нереалізований прибуток/збиток ($ та %)

**Checkbox:**
- "Show zero positions" - показати/сховати закриті позиції (тільки для Portfolio tab)

**Внизу панель статистики (для кожного табу окремі дані):**

**Current tab** (по поточному тікеру):
- **Account** - номер акаунту (з IBKR)
- **Balance** - баланс акаунту (real-time з IBKR)
- **PnL Unrealized** - нереалізований P&L: `$0.00 / 0.00%` (якщо є відкрита позиція)
- **PnL Total** - загальний P&L: `$0.00 / 0.00%` (realized + unrealized по тікеру)
- **Winrate** - % виграшних трейдів по тікеру
- **Number of trades** - кількість закритих трейдів по тікеру
- **Largest win** - найбільший виграш по тікеру: `$0.00 / 0.00%`
- **Largest loss** - найбільший програш по тікеру: `$0.00 / 0.00%`

**All tab** (по всім тікерам за день):
- **Account** - номер акаунту (з IBKR)
- **Balance** - баланс акаунту (real-time з IBKR)
- **PnL Unrealized** - нереалізований P&L: `$0.00 / 0.00%` (сума по всім відкритим позиціям)
- **PnL Total** - загальний P&L: `$0.00 / 0.00%` (realized + unrealized за день)
- **Winrate** - % виграшних трейдів за день
- **Number of trades** - кількість закритих трейдів за день
- **Largest win** - найбільший виграш за день
- **Largest loss** - найбільший програш за день

**Portfolio tab** (з даних IBKR API):
- **Account** - номер акаунту (з IBKR)
- **Balance** - баланс акаунту (real-time з IBKR)
- **Net Liquidation Value** - загальна вартість акаунту
- **PnL Unrealized** - нереалізований P&L: `$0.00 / 0.00%` (з updateAccountValue)
- **PnL Total** - загальний P&L: `$0.00 / 0.00%` (realized + unrealized з updateAccountValue)
- **Winrate** - (те саме що і на All табі)
- **Number of trades** - (те саме що і на All табі)
- **Largest win** - (те саме що і на All табі)
- **Largest loss** - (те саме що і на All табі)

## Trading Logic & Hotkeys

### Opening Positions (Buy)
- `Cmd+O` - Зайти на 100% суми бюджету
- `Cmd+P` - Зайти на 50% суми
- `Cmd+1` - Докупити 5% shares
- `Cmd+2` - Докупити 10% shares
- `Cmd+3` - Докупити 15% shares
- ...
- `Cmd+9` - Докупити 45% shares
- `Cmd+0` - Докупити 50% shares

### Closing Positions (Sell)
- `Cmd+Z` - Sell all shares (100%)
- `Cmd+X` - Sell 75% shares
- `Cmd+C` - Sell 50% shares
- `Cmd+V` - Sell 25% shares

### Other
- `Esc` - Close all pending orders for this ticker
- `Cmd+K` - Open symbol search


## Trading Rules

### Тип ордерів
Order Type: LMT, TimeInForce: OVERNIGHT+DAY, fill outside RTH: true

### General
- Калькуємо кількість акцій % відносно бюджету в settings (округлити вниз до цілого)
- Будь-яка нова IBKR заявка відбувається по поточній real-time ціні:
  - Купівля: `Ask + X` (X задається в settings, default: 10 центів)
  - Продаж: `Bid - Y` (Y задається в settings, default: 10 центів)
- Відкритих позицій + відкритих заявок на покупку **НЕ може бути більше 100%** від початкового бюджету
  - наприклад після серії покупок-продажів в мене залишається відритих на 85%, то я вже не можу зробить +20%, але ще можу +10%
  - робити неактивними кнопки +XX% що виходять за ліміт після кожного оновлення розміру позиції в памʼяті
  - Робити перевірку перед заявкою → жовтий toast warning (на випадок якщо швидко натискали і кнопки не встигли деактивуватися)

### Opening Rules (`Cmd+O`, `Cmd+P`)
**Спрацює тільки якщо немає відкритих позицій** по цьому тікеру:
- Інакше → жовтий toast warning
- Тобто не можна купити 50% а потім ще 50% з `Cmd+P`

**Повторні натиски:**
- Оновлюють попередньо створену pending заявку покупки
- Якщо міняємо 50% на 100% (або навпаки) коли ордер ще pending → оновлює quantity заявки
- Користувач контролює ціну повторним натисненням горячої клавіші (Оновлює попередньо створену pending заявку покупки згідно хоткея 100/50% по поточній Ask+10 з останнього тіку)
- Заявка не оновиться, якщо нова прокалькульована ціна Ask+X така сама як і в pending заявці 
- Оновлена заявка має одразу помінятись в панелі справа

### Adding to Position (`Cmd+1..0`)
**Спрацює тільки коли вже є відкриті позиції** (відкриті з `Cmd+O`,`Cmd+P`):
- Інакше → кнопки не активні

**Повторні натиски:**
- Для pending заявки
  - Оновлюють попередньо створену pending заявку покупки
  - Додають відповідний % до quantity (наприклад було 50%, натиснули `Cmd+2` → стає 60%)
  - Доки не досягнемо qty `position + pending = 100%`
    - Всі кнопки що при натисненні зроблять qty `position + pending > 100%` мають стати неактивними
  - Оновлена заявка має одразу помінятись в панелі справа
- Коли нема pending заявок і позинія відкрита
  - Замість оновлення створить нову заявку
  - Така ж логіка калькуляції і блокування кнопок що і вище

### Selling (`Cmd+Z`, `Cmd+X`, `Cmd+C`, `Cmd+V`)
**відсоток для продажу тут рахується це від поточної відкритої позиції, а не від бюджету**

- Створить заявку, або оновить якщо існує pending.
- На основі останнього тіка `Bid-10` та розрагованого % від позиції (округленого до цілого - floor)

**Повторний натиск - Оновлення заявки (будь-який з `Cmd+Z/X/C/V`):**
- **Оновлює** поточну pending заявку з ціною останнього тіка `Bid-10` разрахувавши % від позиції (заміняє кількиість, а не додає як кнопки +XX%)
  - Якщо міняємо 50% на 25% (коли позицій було 10) то qty 5 -> 2 (де 2 = floor(2.5)) 
  - Якщо повторно натиснули туж саму 50% - це користувач контролює limit оновлюючі заявку по новій поточній ціні з тіка
- Заявка не оновиться, якщо нова прокалькульована ціна Bid-10 та кількість така сама як і в заявці та quantity не змінилась
  - Приклад 1: Було 100 акцій, натиснули `Cmd+C` → заявка на продаж 50 акцій (pending), натиснули `Cmd+Z` → заявка оновлена на 100 акцій
  - Приклад 2: Маємо 100 акцій, натиснули `Cmd+C` → заявка на 50 спрацювала (filled), натиснули `Cmd+C` → нова заявка на 25 акцій (50% від залишкових 50)
  - Приклад 3: Є pending заявка на продаж, ціна пішла не туди → користувач сам вирішує: повторно натиснути хоткей (оновити по новій ціні) або `Cmd+Q` (скасувати)

**Оновлення в панелі:**
- Створена, перестворена, оновлена заявка → одразу оновлюється справа
- Скасовані заявки → зберігаються в історії, показуються якщо checkbox "Show cancelled orders" активний

**Кнопки:**
- Cmd+Z/X/C/V неактивні доки немає відкритих позицій
- Ті кнопки неактивні що сворять округлену заявку менше однієї акції (наприклад позиція 3 акції - не можемо натиснути Close 25%, бо це floor(3*0.25) = 0)


## Additional Rules

### Toast Notifications
- Має мати фіксовану висоту
- Не зсувати і не закривати важливий контент
- Не втрачати фокус основного вікна
- Краще справа внизу
- Пропадати через 10 сек або по кліку


## Settings Dialog (Popup)

Налаштування зберігаються локально в SQLite

### Tab: Trading
- **Account** (dropdown з підтяганням через IBKR API)
- **Budget $** (float .00, default 1000.00) - загальний бюджет на день
  - Не має перевищувать баланс акаунту → червоний toast warning
  - Якщо перевищує 95% → жовтий toast warning
  - При запуску: якщо бюджет > баланс → відкрити settings з warning
  - Перевірка спрацьовує: після зміни поля, вибору іншого акаунту, або при запуску

### Tab: Limits
- **Ask** - `+[int]` - скільки центів вище ask ставити ордер на купівлю (default: 10)
- **Bid** - `-[int]` - скільки центів нижче bid ставити ордер на продаж (default: 10)

### Tab: Hotkeys
Задаємо бажану % акцій для хоткеїв:
- `Cmd+O` - default: 100%
- `Cmd+P` - default: 50%
- `Cmd+1` - default: 5%
- `Cmd+2` - default: 10%
- ...
- `Cmd+0` - default: 50%
- `Cmd+Z` - default: 100%
- `Cmd+X` - default: 75%
- `Cmd+C` - default: 50%
- `Cmd+V` - default: 25%

### Tab: Connection
- **Host** (default: 127.0.0.1)
- **Port** (default: 7496)
- **ClientId** (default: 1)


## Application Lifecycle

### Startup
- Все пусте і неактивне:
  - Список тікерів зліва порожній
  - Історія торгівлі Current справа порожня (бо ще нема вибраного тікера)
  - Поточний тікер пустий
  - Списки неактивні
  - Кнопки трейду неактивні
  - Чарт порожній
- Одразу пробує підключитись до TWS
  - При помилках → тости

### Quit
1. Запитує "Are you sure?"
2. Зупиняє всі стріми і підписки
3. Закриває конекшен
4. Закриває програму

### Reset Session
1. Запитує "Are you sure?"
2. Зупиняє всі стріми і підписки
3. Закриває конекшен
4. Очищує всі дані (історію ордерів, портфоліо, статистику, тікери)
5. Відкриває конекшен і підписується на дані (як при запуску програми)


## Error Handling

### IBKR API Errors
- Всі помилки (створення, оновлення, видалення ордерів) → червоний toast

### Connection Loss
- Клієнт втратив зв'язок з TWS, або TWS з IBKR сервером →
  - Намагається безперервно перепідключитись кожну 1 сек
  - Червоний toast "Reconnecting..."
  - Всі кнопки і функції блокує доки з'єднання не оновлено

### TWS Problems
- TWS запущено але є проблеми (розлогінено юзера тощо) →
  - Пробуємо інтенсивно перепідключитись з червоним повідомленням помилки TWS


## Help & About

### Help
- Відкриває сторінку з інструкцією (англійською)

### About
- Назва застосунку
- Версія: 0.1
- Автор: Kinect.PRO (Anton Pinchuk)
- Посилання: https://kinect-pro.com/solutions/ibkr-hotkey-trader/
- GitHub link
- Ліцензія: MIT


## Technical Details

### Data Storage
- Settings зберігаються в **SQLite** базі даних
- Шлях: OS-specific app data folder
  - macOS: `~/Library/Application Support/IBKRHotkeyTrader/ibkr_hotkey_trader.db`

### IBKR API Integration
- Підключення: localhost socket (TWS API C++ client)
- Протокол: TWS API via EClientSocket
- Real-time data: `reqTickByTickData` для bid/ask
- Historical data: `reqHistoricalData` для свічок
- Orders: через `placeOrder`, `cancelOrder`

### Order Tracking & Deduplication
- Дедуплікація callback-ів -> matching по `orderId` (API orders) або `symbol+action+qty/price` (historical orders)
- Сортування по `permId`

### Threads & mutexes
- EReader потік (TWS API) + main thread Qt timer
- Try-catch в `processMsgs()` для graceful handling
- НЕ використовувати додатковий QMutex (deadlock!)

### Dependencies
- Qt 6.2+
- CMake 3.16+
- Protocol Buffers (protobuf compiler)
- TWS API (окремо завантажується в `external/twsapi`)
